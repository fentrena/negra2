<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Negra Café Club</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-cream: #fdfbf7;
            --text-dark: #4a2c2a;
            --primary-accent: #d97706; /* A warm, inviting terracotta */
            --primary-accent-hover: #b45309;
            --border-soft: #dcd7cd;
            --card-bg: #ffffff;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-cream);
            color: var(--text-dark);
        }
        .font-lora {
            font-family: 'Lora', serif;
        }
        .main-container, .auth-container, .game-container {
            background-color: var(--card-bg);
            border-radius: 1rem;
            border: 1px solid var(--border-soft);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        .info-box {
            background-color: #f9f6f0;
            border: 1px solid var(--border-soft);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .title-text {
             color: var(--text-dark);
        }
        .action-button {
            background-color: var(--primary-accent);
            color: white;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.2s;
        }
        .action-button:hover {
            background-color: var(--primary-accent-hover);
        }
        .action-button:active {
            transform: scale(0.98);
        }
        .action-button:disabled {
            background-color: #a16207;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 1.5rem auto;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: transparent;
        }
        /* <<< FIX: Apply border-radius only to the spin wheel canvas */
        #wheelCanvas {
             border-radius: 50%;
        }
        .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid var(--primary-accent);
            z-index: 10;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: var(--card-bg);
            padding: 2rem; border-radius: 1rem; text-align: center;
            transform: scale(0.9); transition: transform 0.3s ease-in-out;
            position: relative; z-index: 2;
            width: 90%;
            max-width: 400px;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .hidden { display: none; }
        .game-card, .prize-card, .my-reward-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-soft);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        .game-card {
             cursor: pointer;
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        #plinko-canvas-container {
            width: 100%;
            min-height: 400px;
            position: relative;
            background-color: #f9f6f0;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <header id="main-header" class="text-center mb-6">
        <h1 class="text-4xl md:text-5xl font-bold title-text font-lora">Negra Café <span style="color: var(--primary-accent);">Club</span></h1>
        <p class="text-gray-600 mt-2 max-w-lg">Tu dosis diaria de puntos y premios.</p>
    </header>

    <main class="w-full max-w-md">
        <!-- Auth View -->
        <div id="auth-view" class="auth-container p-8 text-center">
            <h1 class="text-3xl font-bold title-text font-lora">Bienvenido</h1>
            <p class="text-gray-500 mt-2 mb-6">Inicia sesión o regístrate para juntar tus $NEGRAS</p>
            <input id="email-input" type="email" placeholder="Ingresa tu email" class="w-full bg-transparent border-2 border-gray-300 rounded-lg p-3 text-center text-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-600 mb-4">
            <input id="referral-code-input" type="text" placeholder="Código de referido (Opcional)" class="w-full bg-transparent border-2 border-gray-300 rounded-lg p-3 text-center text-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-600 mb-4">
            <button id="magic-link-button" class="action-button w-full text-white font-bold py-3 px-4 rounded-lg text-lg">Continuar con Email</button>
            <div class="flex items-center my-4"><hr class="flex-grow border-t border-gray-300"><span class="px-2 text-gray-400 text-sm">O</span><hr class="flex-grow border-t border-gray-300"></div>
            <button id="google-signin-button" class="w-full text-gray-700 font-semibold py-3 px-4 rounded-lg text-lg flex items-center justify-center bg-white border-2 border-gray-300 hover:bg-gray-50">
                <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,36.218,44,30.608,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                Continuar con Google
            </button>
            <p id="auth-message" class="text-green-600 h-6 mt-4"></p>
        </div>

        <!-- Home View -->
        <div id="home-view" class="w-full max-w-md p-6 text-center hidden">
            <h2 id="welcome-message" class="text-3xl font-bold title-text font-lora mb-4"></h2>
            <div class="info-box">
                <div class="flex justify-between items-center text-sm sm:text-base">
                    <div><span class="font-semibold">Saldo:</span> <span id="home-balance" class="font-bold text-lg text-yellow-700">0</span> $NEGRAS</div>
                    <div><span class="font-semibold">Racha Diaria:</span> 🔥<span id="home-streak" class="font-bold">0</span></div>
                </div>
                <button id="logout-button" class="bg-gray-200 text-gray-700 text-xs w-full mt-3 py-1 rounded-md hover:bg-gray-300">Cerrar Sesión</button>
            </div>
             <div class="info-box text-sm">
                <p class="font-bold">Tu Código de Referido:</p>
                <div class="flex justify-center items-center mt-2">
                    <span id="home-referral-code" class="text-gray-700 mr-4 font-semibold"></span>
                    <button id="home-copy-button" class="action-button text-xs py-1 px-3 rounded">Copiar</button>
                </div>
            </div>
             <div class="info-box text-sm">
                <p class="font-bold">Amigos Referidos:</p>
                <p id="referee-count" class="text-2xl text-yellow-700 mt-1 font-bold">0</p>
            </div>
            
            <h3 class="text-2xl font-bold title-text font-lora my-6">Menú</h3>
            <div class="grid grid-cols-1 gap-4">
                <div id="play-spin-wheel" class="game-card">
                    <h3 class="text-xl font-bold">Gira la Rueda</h3>
                    <p class="text-sm text-gray-500 mt-1">¡Una oportunidad de ganar en grande!</p>
                </div>
                <div id="play-plinko" class="game-card">
                    <h3 class="text-xl font-bold">Plinko</h3>
                     <p class="text-sm text-gray-500 mt-1">Mira cómo caen los puntos.</p>
                </div>
                <div id="go-to-rewards" class="game-card">
                    <h3 class="text-xl font-bold">Canjear Premios</h3>
                     <p class="text-sm text-gray-500 mt-1">Gasta tus $NEGRAS.</p>
                </div>
                <div id="go-to-my-rewards" class="game-card">
                    <h3 class="text-xl font-bold">Mis Premios Activos</h3>
                     <p class="text-sm text-gray-500 mt-1">Mira tus códigos de premio.</p>
                </div>
            </div>
        </div>
        
        <!-- Spin Wheel Game View -->
        <div id="spin-wheel-game-view" class="game-container w-full max-w-md p-6 text-center hidden">
            <button class="go-home-button bg-gray-200 text-gray-700 text-xs py-1 px-3 rounded absolute top-4 left-4">← Inicio</button>
            <h1 class="text-3xl font-bold title-text font-lora mt-8">Gira la Rueda</h1>
            <div class="wheel-container"><div class="pointer"></div><canvas id="wheelCanvas" width="300" height="300"></canvas></div>
            <div class="text-gray-600 text-sm">
                <p>Costo: 100 $NEGRAS por giro</p>
                <p class="mt-1">Tu saldo: <span id="spin-current-balance" class="font-semibold">0</span> $NEGRAS</p>
            </div>
            <p id="spin-message" class="text-red-600 h-6 mt-1"></p>
            <button id="spin-button" class="action-button w-full text-white font-bold py-3 px-4 rounded-lg mt-4 text-lg">Girar Ahora</button>
        </div>

        <!-- Plinko Game View -->
        <div id="plinko-game-view" class="game-container w-full max-w-md p-6 text-center hidden">
             <button class="go-home-button bg-gray-200 text-gray-700 text-xs py-1 px-3 rounded absolute top-4 left-4">← Inicio</button>
            <h1 class="text-3xl font-bold title-text font-lora mt-8">Plinko</h1>
            <div id="plinko-canvas-container" class="my-4"></div>
            <div class="text-gray-600 text-sm">
                <p>Costo: 50 $NEGRAS por bola</p>
                <p class="mt-1">Tu saldo: <span id="plinko-current-balance" class="font-semibold">0</span> $NEGRAS</p>
            </div>
             <p id="plinko-message" class="text-red-600 h-6 mt-1"></p>
            <button id="plinko-drop-button" class="action-button w-full text-white font-bold py-3 px-4 rounded-lg mt-4 text-lg">Lanzar Bola</button>
        </div>

        <!-- Rewards View -->
        <div id="rewards-view" class="game-container w-full max-w-md p-6 text-center hidden">
            <button class="go-home-button bg-gray-200 text-gray-700 text-xs py-1 px-3 rounded absolute top-4 left-4">← Inicio</button>
            <h1 class="text-3xl font-bold title-text font-lora mt-8 mb-6">Tienda de Premios</h1>
            <div id="rewards-list" class="space-y-4 text-left">
                <!-- Prize cards will be injected here by JS -->
            </div>
            <p id="rewards-message" class="text-red-600 h-6 mt-4"></p>
        </div>

        <!-- My Rewards View -->
        <div id="my-rewards-view" class="game-container w-full max-w-md p-6 text-center hidden">
            <button class="go-home-button bg-gray-200 text-gray-700 text-xs py-1 px-3 rounded absolute top-4 left-4">← Inicio</button>
            <h1 class="text-3xl font-bold title-text font-lora mt-8 mb-6">Mis Premios Activos</h1>
            <div id="my-rewards-list" class="space-y-4">
                <!-- User's unredeemed rewards will be injected here -->
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="prize-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-2 font-lora">¡Felicidades!</h2>
            <p class="text-gray-600 mb-4">Ganaste</p>
            <p id="prize-amount" class="text-4xl font-bold text-yellow-700 mb-6"></p>
            <button id="close-modal-button" class="action-button text-white font-bold py-2 px-8 rounded-lg">¡Genial!</button>
        </div>
    </div>
    <div id="name-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 font-lora">¡Bienvenido a Negra Café Club!</h2>
            <p class="text-gray-600 mb-4">¿Cómo te llamamos?</p>
            <input id="name-input" type="text" placeholder="Ingresa tu nombre" class="w-full bg-transparent border-2 border-gray-300 rounded-lg p-3 text-center text-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-600 mb-4">
            <button id="submit-name-button" class="action-button w-full text-white font-bold py-3 px-4 rounded-lg text-lg">¡Vamos!</button>
        </div>
    </div>
    <div id="redemption-code-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-2 font-lora">¡Premio Canjeado!</h2>
            <p class="text-gray-600 mb-4">Muestra este código en caja:</p>
            <p id="redemption-code" class="text-3xl font-bold text-yellow-800 tracking-widest bg-yellow-100 rounded-lg p-4 my-4"></p>
            <button id="close-redemption-modal-button" class="action-button text-white font-bold py-2 px-8 rounded-lg">Hecho</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCmtE7GWc5_wlBYw6k7oTo6Dn3kPh1wCr8",
            authDomain: "cafe-ff402.firebaseapp.com",
            projectId: "cafe-ff402",
            storageBucket: "cafe-ff402.appspot.com",
            messagingSenderId: "782947399457",
            appId: "1:782947399457:web:87eac3bd9928103c9ab060",
            measurementId: "G-34RZGQGFSZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const allViews = [
            document.getElementById('auth-view'),
            document.getElementById('home-view'),
            document.getElementById('spin-wheel-game-view'),
            document.getElementById('plinko-game-view'),
            document.getElementById('rewards-view'),
            document.getElementById('my-rewards-view')
        ];
        const mainHeader = document.getElementById('main-header');
        const emailInput = document.getElementById('email-input');
        const referralCodeInput = document.getElementById('referral-code-input');
        const magicLinkButton = document.getElementById('magic-link-button');
        const googleSignInButton = document.getElementById('google-signin-button');
        const authMessage = document.getElementById('auth-message');
        const logoutButton = document.getElementById('logout-button');
        const welcomeMessage = document.getElementById('welcome-message');
        const homeBalance = document.getElementById('home-balance');
        const homeStreak = document.getElementById('home-streak');
        const homeReferralCode = document.getElementById('home-referral-code');
        const homeCopyButton = document.getElementById('home-copy-button');
        const refereeCount = document.getElementById('referee-count');
        const spinCurrentBalance = document.getElementById('spin-current-balance');
        const plinkoCurrentBalance = document.getElementById('plinko-current-balance');
        const rewardsList = document.getElementById('rewards-list');
        const myRewardsList = document.getElementById('my-rewards-list');
        const prizeModal = document.getElementById('prize-modal');
        const modalTitle = document.getElementById('modal-title');
        const prizeAmountEl = document.getElementById('prize-amount');
        const closeModalButton = document.getElementById('close-modal-button');
        const nameModal = document.getElementById('name-modal');
        const nameInput = document.getElementById('name-input');
        const submitNameButton = document.getElementById('submit-name-button');
        const redemptionCodeModal = document.getElementById('redemption-code-modal');
        const redemptionCodeEl = document.getElementById('redemption-code');
        const closeRedemptionModalButton = document.getElementById('close-redemption-modal-button');
        
        let currentUser = null;
        let userDocRef = null;
        let balance = 0;
        let unsubscribeUser;
        let isPlinkoInitialized = false;
        let hasNavigatedHome = false; 

        const tickSynth = new Tone.PluckSynth().toDestination();
        tickSynth.volume.value = -10;
        let isAudioStarted = false;

        function showView(viewToShow) {
            mainHeader.classList.toggle('hidden', viewToShow.id !== 'home-view' && viewToShow.id !== 'auth-view');
            allViews.forEach(view => view.classList.add('hidden'));
            viewToShow.classList.remove('hidden');

            if (viewToShow.id === 'plinko-game-view' && !isPlinkoInitialized) {
                setupPlinko();
                isPlinkoInitialized = true;
            }
            if (viewToShow.id === 'rewards-view') populateRewards();
            if (viewToShow.id === 'my-rewards-view') populateMyRewards();
        }
        
        document.getElementById('play-spin-wheel').addEventListener('click', () => showView(document.getElementById('spin-wheel-game-view')));
        document.getElementById('play-plinko').addEventListener('click', () => showView(document.getElementById('plinko-game-view')));
        document.getElementById('go-to-rewards').addEventListener('click', () => showView(document.getElementById('rewards-view')));
        document.getElementById('go-to-my-rewards').addEventListener('click', () => showView(document.getElementById('my-rewards-view')));
        document.querySelectorAll('.go-home-button').forEach(btn => btn.addEventListener('click', () => showView(document.getElementById('home-view'))));

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                handleUserLogin(user);
            } else {
                currentUser = null;
                if (unsubscribeUser) unsubscribeUser();
                hasNavigatedHome = false; 
                showView(document.getElementById('auth-view'));
            }
        });

        magicLinkButton.addEventListener('click', () => {
            const email = emailInput.value;
            if (!email) { authMessage.textContent = "Por favor, ingresa tu email."; authMessage.style.color = '#ef4444'; return; }
            const actionCodeSettings = { url: window.location.href, handleCodeInApp: true };
            sendSignInLinkToEmail(auth, email, actionCodeSettings)
                .then(() => {
                    window.localStorage.setItem('emailForSignIn', email);
                    const referralCode = referralCodeInput.value.trim();
                    if (referralCode) window.localStorage.setItem('referralCode', referralCode);
                    authMessage.textContent = '¡Enlace mágico enviado! Revisa tu email.';
                    authMessage.style.color = '#16a34a';
                })
                .catch(error => { authMessage.textContent = error.message; authMessage.style.color = '#ef4444'; });
        });

        googleSignInButton.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => { authMessage.textContent = error.message; authMessage.style.color = '#ef4444'; });
        });

        if (isSignInWithEmailLink(auth, window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn');
            if (!email) email = window.prompt('Por favor, ingresa tu email para confirmar');
            signInWithEmailLink(auth, email, window.location.href)
                .then(() => window.localStorage.removeItem('emailForSignIn'))
                .catch(error => { authMessage.textContent = error.message; authMessage.style.color = '#ef4444'; });
        }

        logoutButton.addEventListener('click', () => signOut(auth));

        function handleUserLogin(user) {
            userDocRef = doc(db, "users", user.uid);
            unsubscribeUser = onSnapshot(userDocRef, async (doc) => {
                if (!doc.exists()) {
                    setTimeout(async () => {
                        const userDocCheck = await getDoc(userDocRef);
                        if (!userDocCheck.exists()) {
                            const referralCode = referralCodeInput.value.trim() || window.localStorage.getItem('referralCode');
                            if (currentUser.displayName) {
                                await createNewUser(currentUser.displayName, referralCode);
                            } else {
                                nameModal.classList.add('visible');
                            }
                        }
                    }, 1000);
                } else {
                    const userData = doc.data();
                    const today = new Date().toISOString().split('T')[0];
                    if (userData.lastLogin !== today) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayStr = yesterday.toISOString().split('T')[0];
                        const newStreak = userData.lastLogin === yesterdayStr ? increment(1) : 1;
                        await updateDoc(userDocRef, { balance: increment(100), lastLogin: today, loginStreak: newStreak });
                    }
                    updateUI(userData);
                    if (!hasNavigatedHome) {
                        showView(document.getElementById('home-view'));
                        hasNavigatedHome = true;
                    }
                }
            });
        }
        
        async function createNewUser(name, referralCode) {
            const today = new Date().toISOString().split('T')[0];
            let initialBalance = 500;

            if (referralCode) {
                const q = query(collection(db, "users"), where("referralCode", "==", referralCode.toUpperCase()));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const referrerDoc = querySnapshot.docs[0];
                    if (referrerDoc.id !== currentUser.uid) {
                        const referrerRef = doc(db, "users", referrerDoc.id);
                        await updateDoc(referrerRef, { balance: increment(2500), refereeCount: increment(1) });
                        initialBalance += 1000;
                    }
                }
            }
            
            const newReferralCode = currentUser.uid.substring(0, 6).toUpperCase();
            await setDoc(userDocRef, {
                name: name, email: currentUser.email, balance: initialBalance,
                lastLogin: today, loginStreak: 1, referralCode: newReferralCode, refereeCount: 0
            });
            window.localStorage.removeItem('referralCode');
        }

        submitNameButton.addEventListener('click', async () => {
            const name = nameInput.value;
            if (!name.trim()) return;
            nameModal.classList.remove('visible');
            const referralCode = window.localStorage.getItem('referralCode');
            await createNewUser(name, referralCode);
        });

        function updateUI(data) {
            if (!data) return;
            balance = data.balance;
            welcomeMessage.textContent = `¡Hola, ${data.name}!`;
            homeBalance.textContent = balance.toLocaleString();
            homeStreak.textContent = (data.loginStreak || 1).toLocaleString();
            homeReferralCode.textContent = data.referralCode || '...';
            refereeCount.textContent = (data.refereeCount || 0).toLocaleString();
            spinCurrentBalance.textContent = balance.toLocaleString();
            plinkoCurrentBalance.textContent = balance.toLocaleString();
        }

        homeCopyButton.addEventListener('click', () => {
            const code = homeReferralCode.textContent;
            if (navigator.clipboard && code && code !== '...') {
                navigator.clipboard.writeText(code).then(() => {
                    homeCopyButton.textContent = '¡Copiado!';
                    setTimeout(() => { homeCopyButton.textContent = 'Copiar'; }, 2000);
                });
            }
        });

        const rewards = [
            { id: 'prize1', name: 'Pastel Gratis', cost: 1000 },
            { id: 'prize2', name: '50% Off en Bebidas', cost: 2500 },
            { id: 'prize3', name: 'Bolsa de Café de la Casa', cost: 5000 },
            { id: 'prize4', name: '$5 Off en tu Orden', cost: 7500 },
        ];

        function populateRewards() {
            rewardsList.innerHTML = '';
            rewards.forEach(reward => {
                const canAfford = balance >= reward.cost;
                const card = document.createElement('div');
                card.className = 'prize-card flex justify-between items-center';
                card.innerHTML = `
                    <div>
                        <h3 class="text-lg font-semibold">${reward.name}</h3>
                        <p class="text-yellow-700 text-sm font-semibold">${reward.cost.toLocaleString()} $NEGRAS</p>
                    </div>
                    <button data-prize-id="${reward.id}" class="redeem-button action-button text-sm py-2 px-4" ${!canAfford ? 'disabled' : ''}>
                        Canjear
                    </button>
                `;
                rewardsList.appendChild(card);
            });
            document.querySelectorAll('.redeem-button').forEach(button => button.addEventListener('click', (e) => redeemPrize(e.target.dataset.prizeId)));
        }

        async function redeemPrize(prizeId) {
            const prize = rewards.find(r => r.id === prizeId);
            if (!prize || balance < prize.cost) return;
            try {
                await updateDoc(userDocRef, { balance: increment(-prize.cost) });
                const redemptionCode = `NEGRA-${Date.now().toString().slice(-6)}`;
                await addDoc(collection(db, "users", currentUser.uid, "redemptions"), {
                    prizeName: prize.name, cost: prize.cost, code: redemptionCode,
                    redeemedAt: serverTimestamp(), isUsed: false
                });
                redemptionCodeEl.textContent = redemptionCode;
                redemptionCodeModal.classList.add('visible');
            } catch (error) { console.error("Error al canjear premio: ", error); }
        }

        closeRedemptionModalButton.addEventListener('click', () => {
            redemptionCodeModal.classList.remove('visible');
            populateRewards();
        });
        
        async function populateMyRewards() {
            myRewardsList.innerHTML = '<p class="text-gray-500">Cargando tus premios...</p>';
            if (!currentUser) return;
            const q = query(collection(db, "users", currentUser.uid, "redemptions"), where("isUsed", "==", false));
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    myRewardsList.innerHTML = '<p class="text-gray-500">No tienes premios activos. ¡Ve a canjear algunos!</p>';
                    return;
                }
                myRewardsList.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const reward = doc.data();
                    const card = document.createElement('div');
                    card.className = 'my-reward-card text-left';
                    card.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-800">${reward.prizeName}</h3>
                        <p class="text-sm text-gray-500 mt-1">Tu Código:</p>
                        <p class="text-2xl font-bold text-yellow-800 tracking-widest bg-yellow-100 rounded-lg p-2 mt-1">${reward.code}</p>
                    `;
                    myRewardsList.appendChild(card);
                });
            } catch (error) { console.error("Error al buscar mis premios:", error); }
        }

        const spinCost = 100;
        const spinSegments = [
            { color: '#e5871a', label: '100' }, { color: '#4a2c2a', label: '25' },
            { color: '#facc15', label: '500' }, { color: '#dcd7cd', label: '10' },
            { color: '#5d9c59', label: '75' },  { color: '#e5871a', label: '20' },
            { color: '#4a2c2a', label: '100' }, { color: '#facc15', label: '30' },
            { color: '#dcd7cd', label: '50' },  { color: '#5d9c59', label: '40' },
        ];
        const spinCanvas = document.getElementById('wheelCanvas');
        const spinCtx = spinCanvas.getContext('2d');
        let isSpinning = false;
        let spinCurrentRotation = 0;

        function drawWheel() {
            const segAngle = 2 * Math.PI / spinSegments.length;
            const radius = spinCanvas.width / 2;
            spinCtx.clearRect(0, 0, spinCanvas.width, spinCanvas.height);
            spinCtx.save();
            spinCtx.translate(radius, radius);
            spinCtx.rotate(spinCurrentRotation);
            spinSegments.forEach((segment, i) => {
                const angle = i * segAngle;
                spinCtx.beginPath();
                spinCtx.moveTo(0, 0);
                spinCtx.arc(0, 0, radius - 5, angle, angle + segAngle, false);
                spinCtx.closePath();
                spinCtx.fillStyle = segment.color;
                spinCtx.fill();
                spinCtx.save();
                spinCtx.fillStyle = (segment.color === '#4a2c2a' || segment.color === '#e5871a') ? '#fff' : '#4a2c2a';
                spinCtx.font = 'bold 18px Poppins';
                spinCtx.textAlign = 'center';
                spinCtx.textBaseline = 'middle';
                spinCtx.rotate(angle + segAngle / 2);
                spinCtx.fillText(segment.label, radius * 0.65, 0);
                spinCtx.restore();
            });
            spinCtx.restore();
        }

        async function spin() {
            if (isSpinning) return;
            if (balance < spinCost) { document.getElementById('spin-message').textContent = 'No tienes suficientes $NEGRAS.'; return; }
            if (!isAudioStarted) { await Tone.start(); isAudioStarted = true; }
            isSpinning = true;
            document.getElementById('spin-message').textContent = '';
            await updateDoc(userDocRef, { balance: increment(-spinCost) });
            const targetRotation = (Math.random() * 5 + 5) * 2 * Math.PI;
            let startTime = null;
            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                if (elapsed >= 7000) {
                    spinCurrentRotation = targetRotation;
                    drawWheel();
                    const finalAngle = spinCurrentRotation % (2 * Math.PI);
                    let winningAngle = (3 * Math.PI / 2) - finalAngle;
                    winningAngle = (winningAngle % (2 * Math.PI) + (2 * Math.PI)) % (2 * Math.PI);
                    const winningIndex = Math.floor(winningAngle / (2 * Math.PI / spinSegments.length));
                    const prize = parseInt(spinSegments[winningIndex].label);
                    updateDoc(userDocRef, { balance: increment(prize) });
                    showPrizeModal(prize);
                    isSpinning = false;
                    return;
                }
                const progress = elapsed / 7000;
                spinCurrentRotation = targetRotation * (1 - Math.pow(1 - progress, 3));
                drawWheel();
                requestAnimationFrame(animate);
            }
            requestAnimationFrame(animate);
        }
        document.getElementById('spin-button').addEventListener('click', spin);
        drawWheel();

        const plinkoCost = 50;
        let plinkoEngine, plinkoRenderer, plinkoBuckets = [];

        function setupPlinko() {
            const { Engine, Render, World, Bodies, Events } = Matter;
            plinkoEngine = Engine.create({ gravity: { y: 1.2 } });
            const container = document.getElementById('plinko-canvas-container');
            container.innerHTML = '';
            plinkoRenderer = Render.create({
                element: container, engine: plinkoEngine,
                options: { width: container.clientWidth, height: 400, wireframes: false, background: 'transparent' }
            });
            
            const cols = 10, rows = 9, spacing = container.clientWidth / (cols + 1);
            for (let j = 0; j < rows; j++) {
                const pegsInRow = (j % 2 === 0) ? cols + 1 : cols;
                const xOffset = (j % 2 === 0) ? spacing / 2 : spacing;
                for (let i = 0; i < pegsInRow; i++) {
                    let x = xOffset + i * spacing;
                    World.add(plinkoEngine.world, Bodies.circle(x, 40 + j * 35, 5, { isStatic: true, render: { fillStyle: '#4a2c2a' } }));
                }
            }

            const multipliers = [10, 5, 2, 0.5, 0.2, 0.5, 2, 5, 10];
            const bucketWidth = container.clientWidth / multipliers.length;
            plinkoBuckets = [];
            for (let i = 0; i < multipliers.length; i++) {
                const bucket = Bodies.rectangle(i * bucketWidth + bucketWidth / 2, 400 - 15, bucketWidth, 30, {
                    isStatic: true, isSensor: true, render: { fillStyle: i % 2 === 0 ? '#d97706' : '#b45309' },
                    label: `bucket_${multipliers[i]}`
                });
                plinkoBuckets.push(bucket);
                World.add(plinkoEngine.world, bucket);
            }
            
            World.add(plinkoEngine.world, [
                Bodies.rectangle(-5, 200, 10, 400, { isStatic: true, render: { fillStyle: 'transparent' } }),
                Bodies.rectangle(container.clientWidth + 5, 200, 10, 400, { isStatic: true, render: { fillStyle: 'transparent' } })
            ]);

            Render.run(plinkoRenderer);
            Engine.run(plinkoEngine);

            Events.on(plinkoRenderer, 'afterRender', () => {
                const context = plinkoRenderer.context;
                context.font = 'bold 12px Poppins';
                context.fillStyle = '#fff';
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                plinkoBuckets.forEach((bucket, i) => {
                    context.fillText(`${multipliers[i]}x`, bucket.position.x, bucket.position.y);
                });
            });

            Events.on(plinkoEngine, 'collisionStart', (event) => {
                event.pairs.forEach(pair => {
                    const ball = pair.bodyA.label === 'ball' ? pair.bodyA : (pair.bodyB.label === 'ball' ? pair.bodyB : null);
                    const bucket = pair.bodyA.label.startsWith('bucket_') ? pair.bodyA : (pair.bodyB.label.startsWith('bucket_') ? pair.bodyB : null);
                    if (ball && bucket && !ball.isSleeping) {
                        const multiplier = parseFloat(bucket.label.split('_')[1]);
                        const winnings = Math.floor(plinkoCost * multiplier);
                        updateDoc(userDocRef, { balance: increment(winnings) });
                        showPrizeModal(winnings);
                        Matter.Body.set(ball, 'isSleeping', true);
                        setTimeout(() => World.remove(plinkoEngine.world, ball), 500);
                    }
                });
            });
        }

        async function dropPlinkoBall() {
            if (balance < plinkoCost) { document.getElementById('plinko-message').textContent = 'No tienes suficientes $NEGRAS.'; return; }
            if (!isAudioStarted) { await Tone.start(); isAudioStarted = true; }
            document.getElementById('plinko-message').textContent = '';
            await updateDoc(userDocRef, { balance: increment(-plinkoCost) });
            const { Bodies, World } = Matter;
            const ball = Bodies.circle(plinkoRenderer.options.width / 2 + (Math.random() - 0.5) * 20, 10, 8, {
                restitution: 0.9, friction: 0.05, render: { fillStyle: '#4a2c2a' }, label: 'ball'
            });
            World.add(plinkoEngine.world, ball);
        }
        document.getElementById('plinko-drop-button').addEventListener('click', dropPlinkoBall);

        function showPrizeModal(amount) {
            prizeAmountEl.textContent = `${amount.toLocaleString()} $NEGRAS!`;
            prizeModal.classList.add('visible');
        }
        closeModalButton.addEventListener('click', () => prizeModal.classList.remove('visible'));

    </script>
</body>
</html>
